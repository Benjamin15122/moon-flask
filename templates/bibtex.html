{% macro render_entries(entries, hl="") -%}
<ul class="bibtex">
{% for entry in entries %}
<li><a name="{{ entry.id }}"></a>
{{ render_entry(entry, hl) }}
</li>
{% endfor %}
</ul>
{%- endmacro %}

{% macro render_author(author, hl="") -%}
  {% if hl == author -%}
     <span class="bibtex author hl">{{ author }}</span>
  {%- else -%}
     {{ author }}
  {%- endif%}
{%- endmacro %}

{% macro render_entry(entry, hl="") %}
{% if entry.author -%}
<span class="bibtex author">{% if entry.author|length == 1 -%}
        {{ render_author(entry.author|first, hl) }}{{ ', ' }}
    {%- else -%}
    {% for a in entry.author -%}
        {% if loop.index == entry.author|length -%}
        and {{ render_author(a, hl) }}{{ ', ' }}
        {%- else -%}
        {{ render_author(a, hl) }}{{ ', ' }}
        {%- endif %}
    {%- endfor %}
    {%- endif %}</span>{% endif %}
{% if entry.title %}<span class="bibtex title">“{{ entry.title }}”{% if entry.pdf %}<span><a href="{{ entry.pdf }}" target="_blank" title="Local copy of this paper"> <img src='/static/img/icon-pdf.png'/></a></span>{% endif %},</span>{% endif %}
{% if entry.booktitle %}<span class="bibtex pages">in </span><span class="bibtex booktitle">{{ entry.booktitle }}</span>{% endif %}{% if entry.journal %}<span class="bibtex journal">{{ entry.journal }}</span>{% endif %}
{% if entry.link %}<span><a href="{{ entry.link }}" target="_blank" title="Publication site of this paper"><img src='/static/img/icon-link.png'/></a></span>{% endif %}{% if entry.booktitle or entry.journal %}<span>, </span>{% endif %}
{% if entry.pages %}<span class="bibtex pages">{{ entry.pages }},</span>{% endif %}
{% if entry.year %}<span class="bibtex year">{{ entry.year}}.</span>{% endif %}
{%- endmacro %}

{% macro render_entries_group_by_year(years, grouped_entries, hl="") -%}
<p>
{% for year,__ in years %}
[<a href="#{{ year }}">{{ year }}</a>]
{% endfor %}
</p>
{% for year, entries in grouped_entries %}
<h2><a name="{{ year }}"></a>{{ year }}</h2>
<hr/>
{{ render_entries(entries, hl) }}
<hr/>
{% endfor %}
{%- endmacro %}
